<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments :: head (titulo='Calendario de Tareas')">
</head>

<body>
<div class="container-fluid">

    <nav th:replace="fragments :: navbar"></nav>

    <div class="container">
        <div class="row mt-3">
            <div class="col">
                <h2 class="mb-3">
                    <i class="bi bi-calendar3"></i> Calendario de Tareas
                </h2>

                <div class="mb-3">
                    <a th:href="@{/usuarios/{id}/tareas(id=${usuario.id})}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-list-task"></i> Ver Lista de Tareas
                    </a>
                    <a th:href="@{/usuarios/{id}/tareas/nueva(id=${usuario.id})}" class="btn btn-success btn-sm">
                        <i class="bi bi-plus-circle"></i> Nueva Tarea Personal
                    </a>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <button id="prevMonth" class="btn btn-outline-primary">
                                <i class="bi bi-chevron-left"></i> Anterior
                            </button>
                            <h4 id="currentMonth" class="mb-0"></h4>
                            <button id="nextMonth" class="btn btn-outline-primary">
                                Siguiente <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>Leyenda de Estados:</strong>
                    <span class="badge" style="background-color: #4caf50; color: white;">Terminada</span>
                    <span class="badge" style="background-color: #ff9800; color: white;">En Curso</span>
                    <span class="badge" style="background-color: #2196f3; color: white;">Pendiente</span>
                    <br>
                    <strong class="mt-2 d-inline-block">Tipos de Tarea:</strong>
                    <span class="badge" style="background-color: #2196f3; color: white;"><i class="bi bi-person"></i> Personal</span>
                    <span class="badge" style="background-color: #00bcd4; color: white;"><i class="bi bi-people"></i> Equipo</span>
                    <span class="badge" style="background-color: #ff5722; color: white;"><i class="bi bi-folder"></i> Proyecto</span>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div id="calendar" class="calendar-grid"></div>
                    </div>
                </div>

                <div class="modal fade" id="tareasModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="modalTitle">Tareas del d√≠a</h5>
                                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body" id="modalBody">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="tareaDetalleModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="tareaDetalleTitle">Detalles de la Tarea</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body" id="tareaDetalleBody">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                <a id="btnVerDetalles" href="#" class="btn btn-info">
                                    <i class="bi bi-eye"></i> Ver Detalles Completos
                                </a>
                                <button type="button" id="btnEliminarTarea" class="btn btn-danger">
                                    <i class="bi bi-trash"></i> Eliminar Tarea
                                </button>
                                <a id="btnEditarTarea" href="#" class="btn btn-primary">
                                    <i class="bi bi-pencil"></i> Editar Tarea
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="modalConfirmarBorrado" tabindex="-1" role="dialog" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content border-0 shadow">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title font-weight-bold">Eliminar Tarea</h5>
                                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body text-center p-4">
                                <div class="mb-3">
                                    <span style="font-size: 3rem;">üóëÔ∏è</span>
                                </div>
                                <p class="mb-1">¬øEst√°s seguro de que quieres eliminar esta tarea?</p>
                                <h5 class="font-weight-bold text-dark mt-2" id="txtTituloBorrar">T√≠tulo Tarea</h5>
                                <p class="text-muted small mt-3">Esta acci√≥n no se puede deshacer.</p>
                            </div>
                            <div class="modal-footer justify-content-center border-top-0 pb-4">
                                <button type="button" class="btn btn-light px-4 mr-2" data-dismiss="modal">Cancelar</button>
                                <button type="button" id="btnConfirmarEliminacionFinal" class="btn btn-danger px-4 font-weight-bold">S√≠, Eliminar</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const tareas = /*[[${tareas}]]*/ [];
    const usuario = /*[[${usuario}]]*/ {};
    const equipos = /*[[${equipos}]]*/ [];
    const proyectos = /*[[${proyectos}]]*/ [];

    let currentDate = new Date();
    // Variable para almacenar la tarea que se va a borrar temporalmente
    let tareaParaBorrar = null;

    const equiposMap = {};
    equipos.forEach(equipo => {
        equiposMap[equipo.id] = equipo.nombre;
    });

    const proyectosMap = {};
    proyectos.forEach(proyecto => {
        proyectosMap[proyecto.id] = proyecto.nombre;
    });

    function obtenerNombreProyecto(proyectoId) {
        return proyectosMap[proyectoId] || 'Proyecto #' + proyectoId;
    }

    function obtenerTipoTarea(tarea) {
        if (tarea.proyectoId) {
            return {
                tipo: 'Proyecto',
                nombre: obtenerNombreProyecto(tarea.proyectoId),
                icono: 'bi-folder',
                clase: 'tipo-proyecto'
            };
        } else if (tarea.equipoId) {
            return {
                tipo: 'Equipo',
                nombre: equiposMap[tarea.equipoId] || 'Equipo #' + tarea.equipoId,
                icono: 'bi-people',
                clase: 'tipo-equipo'
            };
        } else {
            return {
                tipo: 'Personal',
                nombre: '',
                icono: 'bi-person',
                clase: 'tipo-personal'
            };
        }
    }

    const tareasMap = {};
    tareas.forEach(tarea => {
        if (tarea.fechaLimite) {
            const fecha = tarea.fechaLimite;
            if (!tareasMap[fecha]) {
                tareasMap[fecha] = [];
            }
            tareasMap[fecha].push(tarea);
        }
    });

    function renderCalendar(year, month) {
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        document.getElementById('currentMonth').textContent = monthNames[month] + ' ' + year;

        const weekDays = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
        weekDays.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'calendar-day-header';
            dayHeader.textContent = day;
            calendar.appendChild(dayHeader);
        });

        const firstDay = new Date(year, month, 1);
        let startDay = firstDay.getDay() - 1;
        if (startDay < 0) startDay = 6;

        const lastDay = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < startDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendar.appendChild(emptyDay);
        }

        for (let day = 1; day <= lastDay; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            const today = new Date();

            if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                dayElement.classList.add('today');
            }

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayElement.appendChild(dayNumber);

            if (tareasMap[dateStr]) {
                const tareasDelDia = tareasMap[dateStr];
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'tasks-container';

                tareasDelDia.slice(0, 3).forEach(tarea => {
                    const tipoInfo = obtenerTipoTarea(tarea);
                    const taskBadge = document.createElement('div');
                    taskBadge.className = 'task-badge';

                    if (tarea.estado === 'TERMINADA') {
                        taskBadge.classList.add('terminada');
                    } else if (tarea.estado === 'EN_CURSO') {
                        taskBadge.classList.add('en-progreso');
                    } else {
                        taskBadge.classList.add('pendiente');
                    }

                    const tipoIcono = document.createElement('i');
                    tipoIcono.className = 'bi ' + tipoInfo.icono;
                    taskBadge.appendChild(tipoIcono);

                    const textoSpan = document.createElement('span');
                    textoSpan.textContent = tarea.titulo;
                    textoSpan.style.flex = '1';
                    textoSpan.style.overflow = 'hidden';
                    textoSpan.style.textOverflow = 'ellipsis';
                    taskBadge.appendChild(textoSpan);

                    taskBadge.title = tipoInfo.tipo + ': ' + tarea.titulo;

                    taskBadge.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showTareaDetalleModal(tarea, tipoInfo);
                    });

                    tasksContainer.appendChild(taskBadge);
                });

                if (tareasDelDia.length > 3) {
                    const moreBadge = document.createElement('div');
                    moreBadge.className = 'task-badge more';
                    moreBadge.textContent = '+' + (tareasDelDia.length - 3) + ' m√°s';
                    moreBadge.addEventListener('click', function(e) {
                        e.stopPropagation();
                        showTasksModal(dateStr, tareasDelDia, day, month, year);
                    });
                    tasksContainer.appendChild(moreBadge);
                }

                dayElement.appendChild(tasksContainer);
                dayElement.classList.add('has-tasks');
            }

            dayElement.addEventListener('click', function(e) {
                if (!e.target.closest('.task-badge')) {
                    const tareasDelDia = tareasMap[dateStr] || [];
                    showTasksModal(dateStr, tareasDelDia, day, month, year);
                }
            });

            calendar.appendChild(dayElement);
        }
    }

    function showTasksModal(dateStr, tareas, day, month, year) {
        const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const modalTitle = document.getElementById('modalTitle');
        modalTitle.textContent = 'Tareas del ' + day + ' de ' + monthNames[month] + ' de ' + year;

        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = '';

        if (tareas.length === 0) {
            modalBody.innerHTML = '<p class="text-muted text-center py-4">No hay tareas para este d√≠a</p>';
        } else {
            const listGroup = document.createElement('div');
            listGroup.className = 'list-group';

            tareas.forEach(function(tarea) {
                const tipoInfo = obtenerTipoTarea(tarea);
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.style.cursor = 'pointer';

                let badgeStyle = '';
                let estadoText = 'Pendiente';

                if (tarea.estado === 'TERMINADA') {
                    badgeStyle = 'background-color: #4caf50; color: white;';
                    estadoText = 'Terminada';
                } else if (tarea.estado === 'EN_CURSO') {
                    badgeStyle = 'background-color: #ff9800; color: white;';
                    estadoText = 'En Curso';
                } else {
                    badgeStyle = 'background-color: #2196f3; color: white;';
                    estadoText = 'Pendiente';
                }

                const html = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="bi ${tipoInfo.icono}"></i> ${tarea.titulo}
                        </h6>
                        <span class="badge" style="${badgeStyle}">${estadoText}</span>
                    </div>
                    <p class="mb-1 text-muted small">
                        <strong>${tipoInfo.tipo}:</strong> ${tipoInfo.nombre || 'Tarea personal'}
                    </p>
                `;

                item.innerHTML = html;
                item.addEventListener('click', function() {
                    jQuery('#tareasModal').modal('hide');
                    showTareaDetalleModal(tarea, tipoInfo);
                });

                listGroup.appendChild(item);
            });

            modalBody.appendChild(listGroup);
        }

        jQuery('#tareasModal').modal('show');
    }

    function showTareaDetalleModal(tarea, tipoInfo) {
        const modalTitle = document.getElementById('tareaDetalleTitle');
        modalTitle.textContent = tarea.titulo;

        const modalBody = document.getElementById('tareaDetalleBody');

        let estadoBadge = '';
        let estadoStyle = '';
        let estadoText = 'Pendiente';

        if (tarea.estado === 'TERMINADA') {
            estadoStyle = 'background-color: #4caf50; color: white;';
            estadoText = 'Terminada';
        } else if (tarea.estado === 'EN_CURSO') {
            estadoStyle = 'background-color: #ff9800; color: white;';
            estadoText = 'En Progreso';
        } else {
            estadoStyle = 'background-color: #2196f3; color: white;';
            estadoText = 'Pendiente';
        }

        let html = '<div class="info-row">' +
            '<div class="info-label"><i class="bi bi-card-text"></i> T√≠tulo</div>' +
            '<div class="info-value">' + tarea.titulo + '</div></div>' +
            '<div class="info-row">' +
            '<div class="info-label"><i class="bi bi-diagram-3"></i> Estado</div>' +
            '<div class="info-value"><span class="badge" style="' + estadoStyle + '">' + estadoText + '</span></div></div>' +
            '<div class="info-row">' +
            '<div class="info-label"><i class="bi bi-tag"></i> Tipo de Tarea</div>' +
            '<div class="info-value"><span class="badge ' + tipoInfo.clase + '"><i class="bi ' + tipoInfo.icono + '"></i> ' +
            tipoInfo.tipo + (tipoInfo.nombre ? ': ' + tipoInfo.nombre : '') + '</span></div></div>' +
            '<div class="info-row">' +
            '<div class="info-label"><i class="bi bi-calendar3"></i> Fecha L√≠mite</div>' +
            '<div class="info-value">' + (tarea.fechaLimite ? new Date(tarea.fechaLimite).toLocaleDateString('es-ES', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            }) : 'Sin fecha') + '</div></div>' +
            '<div class="info-row">' +
            '<div class="info-label"><i class="bi bi-person-circle"></i> Usuario Asignado</div>' +
            '<div class="info-value"><span class="badge bg-info"><i class="bi bi-person"></i> ' + usuario.nombre + '</span></div></div>';

        if (tarea.equipoId) {
            html += '<div class="alert alert-info mb-0 mt-3">' +
                '<h6 class="alert-heading"><i class="bi bi-people-fill"></i> Informaci√≥n del Equipo</h6><hr>' +
                '<p class="mb-0"><strong>Equipo:</strong> ' + (equiposMap[tarea.equipoId] || 'Equipo #' + tarea.equipoId) + '</p></div>';
        }

        if (tarea.proyectoId) {
            html += '<div class="alert alert-warning mb-0 mt-3">' +
                '<h6 class="alert-heading"><i class="bi bi-folder-fill"></i> Informaci√≥n del Proyecto</h6><hr>' +
                '<p class="mb-0"><strong>Proyecto:</strong> ' + obtenerNombreProyecto(tarea.proyectoId);
            if (tarea.equipoId) {
                html += '<br><strong>Equipo asociado:</strong> ' + (equiposMap[tarea.equipoId] || 'Equipo #' + tarea.equipoId);
            }
            html += '</p></div>';
        }

        if (!tarea.equipoId && !tarea.proyectoId) {
            html += '<div class="alert alert-primary mb-0 mt-3">' +
                '<h6 class="alert-heading"><i class="bi bi-person-badge"></i> Tarea Personal</h6><hr>' +
                '<p class="mb-0">Esta es una tarea <strong>personal</strong> que no est√° asociada a ning√∫n equipo ni proyecto.</p></div>';
        }

        modalBody.innerHTML = html;

        const btnEditar = document.getElementById('btnEditarTarea');
        btnEditar.href = '/tareas/' + tarea.id + '/editar';

        const btnVerDetalles = document.getElementById('btnVerDetalles');
        btnVerDetalles.href = '/tareas/' + tarea.id;

        // Configuraci√≥n del bot√≥n eliminar para abrir el modal de confirmaci√≥n
        const btnEliminar = document.getElementById('btnEliminarTarea');
        if (btnEliminar) {
            btnEliminar.onclick = function() {
                // Guardamos la tarea en variable global para borrarla despu√©s
                tareaParaBorrar = tarea;
                // Actualizamos el texto del modal de confirmaci√≥n
                document.getElementById('txtTituloBorrar').textContent = tarea.titulo;
                // Ocultamos el modal de detalles
                jQuery('#tareaDetalleModal').modal('hide');
                // Mostramos el modal de confirmaci√≥n
                jQuery('#modalConfirmarBorrado').modal('show');
            };
        }

        jQuery('#tareaDetalleModal').modal('show');
    }

    // L√≥gica para el bot√≥n "S√≠, Eliminar" del nuevo modal
    document.getElementById('btnConfirmarEliminacionFinal').addEventListener('click', function() {
        if (tareaParaBorrar) {
            fetch('/tareas/' + tareaParaBorrar.id, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        // Actualizar datos locales
                        const index = tareas.findIndex(t => t.id === tareaParaBorrar.id);
                        if (index > -1) {
                            tareas.splice(index, 1);
                        }

                        const fecha = tareaParaBorrar.fechaLimite;
                        if (tareasMap[fecha]) {
                            const indexEnMapa = tareasMap[fecha].findIndex(t => t.id === tareaParaBorrar.id);
                            if (indexEnMapa > -1) {
                                tareasMap[fecha].splice(indexEnMapa, 1);
                                if (tareasMap[fecha].length === 0) {
                                    delete tareasMap[fecha];
                                }
                            }
                        }

                        // Cerrar modal y renderizar
                        jQuery('#modalConfirmarBorrado').modal('hide');
                        renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                        // Ya no mostramos alert(), simplemente se actualiza la vista
                    } else {
                        alert('Error al eliminar la tarea');
                    }
                    tareaParaBorrar = null; // Limpiar variable
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al eliminar la tarea');
                });
        }
    });

    document.getElementById('prevMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    document.getElementById('nextMonth').addEventListener('click', function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    });

    renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
    /*]]>*/
</script>

<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }

    .calendar-day-header {
        font-weight: bold;
        text-align: center;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border-radius: 5px;
    }

    .calendar-day {
        min-height: 100px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 5px;
        background-color: #fff;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .calendar-day:hover {
        background-color: #f8f9fa;
    }

    .calendar-day.empty {
        background-color: #f8f9fa;
        cursor: default;
    }

    .calendar-day.today {
        background-color: #e7f3ff;
        border: 2px solid #007bff;
    }

    .calendar-day.has-tasks {
        background-color: #fff3cd;
    }

    .day-number {
        font-weight: bold;
        margin-bottom: 5px;
        color: #495057;
    }

    .tasks-container {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .task-badge {
        font-size: 0.75rem;
        padding: 3px 6px;
        border-radius: 3px;
        cursor: pointer;
        transition: transform 0.1s;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .task-badge:hover {
        transform: scale(1.05);
    }

    .task-badge.terminada {
        background-color: #4caf50;
        color: white;
    }

    .task-badge.en-progreso {
        background-color: #ff9800;
        color: white;
    }

    .task-badge.pendiente {
        background-color: #2196f3;
        color: white;
    }

    .task-badge.more {
        background-color: #6c757d;
        color: white;
        text-align: center;
        justify-content: center;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .info-label {
        font-weight: bold;
        color: #495057;
    }

    .info-value {
        color: #343a40;
    }
</style>

<div th:replace="fragments::javascript"></div>

</body>
</html>